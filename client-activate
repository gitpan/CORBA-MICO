#!/usr/bin/perl -w

use CORBA::MICO;
use Error qw(:try);

use strict;

my $orb = CORBA::ORB_init("mico-local-orb");
my $boa = $orb->BOA_init("mico-local-boa");

#print "Sleeping...\n";
#sleep 5;
#print "...done\n";

my $account = $orb->bind('IDL:Account/Account:1.0');

$account->_set_prefs ( { favorite_color => 'taupe',
		         lottery_numbers => [ 21, 63, 83, 96 ],
		         nickname => 'Dopey' });

for (my $i=0;$i<0;$i++) {
    $account->deposit( 1 );
}
$account->deposit( 100 );
$account->deposit( 100 );
$account->deposit( 100 );
$account->deposit( 100 );
$account->deposit( 100 );
$account->withdraw( 240 );
$account->withdraw( 10 );

print "Balance is ".$account->balance."\n";

my $prefs = $account->_get_prefs;
print "Favorite color is ",$prefs->{favorite_color},"\n";
print "Lottery numbers are ",
    join(" ", @{$prefs->{lottery_numbers}}),"\n";
print "Nickname is ",$prefs->{nickname},"\n";
$account->set_pref ( [ 'pt_color', 'chartreuse', ] );
$account->set_pref ( [ 'pt_nickname', 'Grumpy', ] );

print "Closing server...\n";
$account->server_exit;
print "Trying to reactivate...\n";

print "Favorite color is now ",$account->get_pref('pt_color')->[1],"\n";
print "As an any: favorite color is now ",
          $account->get_pref_any('pt_color')->value,"\n";
print "As an any: nickname is now ",
          $account->get_pref_any('pt_nickname')->value,"\n";

print "Withdrawing \$100,000\n";
try {
    $account->withdraw (100_000);
} catch Account::Account::InsufficientFunds with {
    my $e = shift;
    print STDERR "Oops. I don't have that much money\n";
    print STDERR "    (I need $e->{overdraft} more)\n";
}

my $counter = $account->counter();
print join(" ", map { $counter->next } (1..10)), "\n";

# Don't do this test while forwarding through micod
#
#$counter->destroy();
#try {
#    $counter->next;
#} catch CORBA::Exception with {
#    print "Caught $_[0], while counting with a destroyed counter\n";
#};

print "Successful completion\n"
